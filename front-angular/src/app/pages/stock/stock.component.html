
<app-topbar></app-topbar>
<app-menu-desktop></app-menu-desktop>
<div id="login-background" class="container-fluid d-flex justify-content-center align-items-center"></div>
<h2 class="title-page">Gerenciar Estoque</h2>

<div class="top-content">
<button type="button" class="btn-add" (click)="abrirModal()">+ Adicionar</button>

<p class="quantity-tables">Quantidade de tabelas: {{ tabelasSetor.length }}</p>

<div class="top-line"></div>
</div>
<div class="div-content">
  <div *ngFor="let tabela of tabelasSetor" class="table-information-content">
    <h1 style="margin-bottom: 10px;">{{ tabela.tableName }}</h1>
    <p class="description">Descrição: {{ tabela.description }}</p>
    <p class="quantity" style="margin-bottom: 50px;">Quantidade de itens: {{ tabela.itemCount || 0 }}</p>
    <div class="line-div-table"></div>
    <button type="button" class="btn btn-outline-secondary" style="margin-left: -20px;" (click)="abrirModalDetalhesTabela(tabela)">Entrar</button>
    <button type="button" class="btn btn-outline-danger">Excluir</button>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>Criar Nova Tabela</h2>
      <p>Configure uma nova tabela para organizar seus produtos</p>
    </div>

<div class="form-group">
  <label>Nome da Tabela</label>
  <input
    type="text"
    class="uppercase"
    placeholder="Ex: GELADEIRA"
    [(ngModel)]="nomeTabela"
    (ngModelChange)="nomeTabela = nomeTabela.toUpperCase()"
  />
</div>

<div class="form-group">
  <label>Descrição (Opcional)</label>
  <input
    type="text"
    placeholder="Ex: Pratileria A-H"
    [(ngModel)]="descricaoTabela"
  />
</div>


    <div class="form-group">
      <div class="coluna-header">
        <label>Colunas da Tabela</label>
        <button class="btn-add-coluna" (click)="adicionarColuna()">+ Adicionar Coluna</button>
      </div>

      <div *ngFor="let col of colunas; let i = index" class="coluna-item">
        <input type="text" [(ngModel)]="colunas[i].nome" placeholder="Nome da Coluna" />

        <select [(ngModel)]="colunas[i].tipo">
          <option value="texto">Texto</option>
          <option value="número">Número</option>
          <option value="data">Data</option>
        </select>

        <label class="obrigatorio">
          <input type="checkbox" [(ngModel)]="colunas[i].obrigatorio" />
          Obrigatório
        </label>

        <button *ngIf="colunas.length > 1" class="btn-remove" (click)="removerColuna(i)">×</button>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancelar" (click)="fecharModal()">Cancelar</button>
      <button class="btn-confirmar" (click)="confirmarCriacao()" [disabled]="!isFormValid()">Criar Tabela</button>
    </div>
  </div>
</div>
<div class="itens-tabela-container" *ngIf="itensTabelaSelecionada.length > 0">
  <h3>Produtos adicionados</h3>
  <div *ngFor="let item of itensTabelaSelecionada" class="item-tabela-row">
    <div class="item-nome">{{ item.name }}</div>
    <div class="item-campos">
      <div *ngFor="let coluna of tabelaSelecionada?.colunas" class="campo-item">
        <label>{{ coluna.nome }}:</label>
        <ng-container *ngIf="coluna.nome.toLowerCase() === 'nome'; else inputField">
          <span>{{ item.fields[coluna.nome] || item.fields[coluna.nome.toLowerCase()] }}</span>
        </ng-container>
        <ng-template #inputField>
          <input 
            [type]="coluna.tipo === 'número' ? 'number' : 'text'"
            [(ngModel)]="item.fields[coluna.nome]" />
        </ng-template>
      </div>
    </div>
  </div>
</div>
<div class="modal-detalhes-tabela"
     [class.show]="modalDetalhesTabelaAberto"
     (click)="fecharModalDetalhesTabela($event)">
  <div class="modal-detalhes-tabela-content" (click)="$event.stopPropagation()">
    <h2>{{ tabelaSelecionada?.tableName || 'Tabela' }}</h2>
    <p>{{ tabelaSelecionada?.description || 'Sem descrição' }}</p>
    <button *ngIf="mostrarBotaoAdd && tabelaSelecionada"
            class="btn-open-add-products"
            (click)="abrirSidebarProdutos()">+</button>
    <div class="table-items-container" *ngIf="itensTabela.length > 0 && colunasTabelaSelecionada.length > 0; else semItens">
      <table>
        <thead>
          <tr>
            <th *ngFor="let coluna of colunasTabelaSelecionada">
              {{ coluna.nome || '-' }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of itensTabela">
            <td *ngFor="let coluna of colunasTabelaSelecionada">
              {{ coluna.nomeKey ? item.fields[coluna.nomeKey] ?? '-' : '-' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #semItens>
      <p>Nenhum item adicionado.</p>
    </ng-template>
    <div class="modal-actions">
      <button (click)="editarTabela()" [disabled]="!tabelaSelecionada">Editar</button>
      <button (click)="fecharModalDetalhesTabela()">Fechar</button>
    </div>
  </div>
</div>

<div class="sidebar-produtos" [class.show]="mostrarSidebarProdutos" (click)="$event.stopPropagation()">
  <button (click)="mostrarSidebarProdutos = false">Fechar</button>
  <h3>Produtos disponíveis</h3>
  <div *ngFor="let produto of productsBaseList" class="produto-item">
    <label>
      <input type="checkbox" [(ngModel)]="produtoSelecionado[produto.id]" />
      {{ produto?.name }}
    </label>
  </div>
  <button (click)="confirmarSelecaoProdutos(); salvarProdutos()">Confirmar</button>
</div>

