<app-topbar></app-topbar>
<app-menu-desktop></app-menu-desktop>
<div id="login-background" class="container-fluid d-flex justify-content-center align-items-center"></div>
<div class="user-management-content">
  <h1>Gerenciamento de Usuários</h1>
  <p>Gerencie todos os usuários do sistema</p>
  <button *ngIf="canCreate()" class="add-user" (click)="openNewUserModal()">Criar Usuário</button>
  <button class="btn-notification-user" (click)="openModalNotification()">Enviar Notificações</button>
  <div class="horizontal-line"></div>
  <div class="status-user-content">
    <div class="input-group">
      <input type="text" class="form-control" placeholder="Procurar..." [(ngModel)]="searchText" />
      <button type="button" class="btn btn-outline-secondary" (click)="searchUsers()">Buscar</button>
      <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split"
        data-bs-toggle="dropdown" aria-expanded="false">
        <span class="visually-hidden">Filtro</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" (click)="setRoleFilter('user')">User</a></li>
        <li><a class="dropdown-item" (click)="setRoleFilter('admin')">Admin</a></li>
        <li>
          <hr class="dropdown-divider" />
        </li>
        <li><a class="dropdown-item" (click)="setRoleFilter('Todos')">Todos</a></li>
      </ul>
    </div>
    <div class="activity-box">
      <div class="line-activity" *ngFor="let user of filteredUsers">
        <div class="user-info">
          <h3>{{ user.username }}</h3>
          <p>{{ user.email }}</p>
        </div>
        <div class="user-details">
          <span class="user-role">{{ user.roleName }}</span>
          <span class="data-alteracao">Última alteração: {{ formatDateTime(user.lastModified) }}</span>
        </div>
        <div class="user-actions">
          <button *ngIf="canEdit()" class="change-user" (click)="editUser(user)">
            <img src="/register/pen-icon.svg" alt="Editar" />
          </button>
          <button *ngIf="canDelete()" class="delete-user" (click)="openDeleteModal(user)">
            <img src="/register/lixeira-icon.svg" alt="Excluir" />
          </button>
        </div>
      </div>
    </div>
    <div class="user-activity-container">
      <div class="user-activity">
        <h3>Total de Usuários</h3>
        <img src="/register/user-multiple.svg" alt="" />
        <p>{{ totalUsers }}</p>
      </div>
    </div>
  </div>
</div>
<div class="modal-novo-usuario-overlay" *ngIf="showNewUserModal" (click)="closeNewUserModal()">
  <div class="modal-novo-usuario-conteudo" (click)="$event.stopPropagation()">
    <h2 class="modal-novo-usuario-titulo">Novo Usuário</h2>
    <img src="/register/icon-close.svg" alt="Fechar" class="modal-novo-usuario-close" (click)="closeNewUserModal()" />
    <div class="modal-novo-usuario-corpo">
      <p class="modal-novo-usuario-label">Nome</p>
      <input type="text" [(ngModel)]="newUser.username" name="username" class="modal-novo-usuario-input" />
      <p class="modal-novo-usuario-label">Email</p>
      <input type="text" [(ngModel)]="newUser.email" name="email" class="modal-novo-usuario-input" />
      <p class="modal-novo-usuario-label">Função</p>
      <select [(ngModel)]="newUser.roleName" name="role" class="modal-novo-usuario-select">
        <option value="user">Usuário</option>
        <option value="admin">Administrador</option>
      </select>
      <p class="modal-novo-usuario-label">Senha</p>
      <input type="text" [(ngModel)]="newUser.password" name="password" class="modal-novo-usuario-input" />
      <div class="modal-novo-usuario-botoes">
        <button type="button" class="modal-novo-usuario-btn-gerar" (click)="generateRandomPassword()">
          Gerar Senha Forte
        </button>
        <button type="button" class="modal-novo-usuario-btn-confirmar" (click)="createUser()">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="notif-modal-overlay" *ngIf="showNotificationModal" (click)="closeModalNotification()">
  <div class="notif-modal-container" (click)="$event.stopPropagation()">
    <h2 class="notif-modal-title">Enviar Notificação</h2>
    <img src="/register/icon-close.svg" alt="Fechar" class="notif-modal-close" (click)="closeModalNotification()" />
    <div class="notif-modal-body">
      <label class="notif-modal-label">Título</label>
      <input type="text" [(ngModel)]="newNotification.titulo"
        (ngModelChange)="newNotification.titulo = $event.toUpperCase()" class="notif-modal-input" />
      <label class="notif-modal-label">Tipo</label>
      <select [(ngModel)]="newNotification.tipo" class="notif-modal-select">
        <option value="Urgência">Urgência</option>
        <option value="Comunicado">Comunicado</option>
        <option value="Atenção">Atenção</option>
      </select>
      <label class="notif-modal-label">Descrição</label>
      <textarea [(ngModel)]="newNotification.descricao" rows="4" class="notif-modal-textarea"></textarea>
      <label class="notif-modal-label">Destinatários</label>
      <select multiple [(ngModel)]="newNotification.destinatarios" disabled class="notif-modal-select-multi">
        <option *ngFor="let user of users" [value]="user.username">{{ user.username }}</option>
      </select>
    </div>
    <div class="notif-modal-buttons">
      <button type="button" class="notif-modal-btn-send" (click)="sendNotification()">Enviar</button>
      <button type="button" class="notif-modal-btn-cancel" (click)="closeModalNotification()">Cancelar</button>
    </div>
  </div>
</div>
<div class="edit-user-modal-overlay" *ngIf="showEditCard && selectedUser" (click)="closeEditCard()">
  <div class="edit-user-modal-container" (click)="$event.stopPropagation()">
    <h2 class="edit-user-modal-title">Editar Usuário</h2>
    <div class="edit-user-modal-body">
      <label class="edit-user-modal-label">Nome:</label>
      <input type="text" [(ngModel)]="selectedUser.username" [readonly]="showConfirm" class="edit-user-modal-input" />
      <label class="edit-user-modal-label">Email:</label>
      <input type="text" [(ngModel)]="selectedUser.email" [readonly]="showConfirm" class="edit-user-modal-input" />
      <label class="edit-user-modal-label">Função:</label>
      <select [(ngModel)]="selectedUser.roleName" [disabled]="showConfirm" class="edit-user-modal-select">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div class="edit-user-modal-buttons" *ngIf="!showConfirm">
      <button class="edit-user-btn-save" (click)="askForConfirm()">Salvar</button>
      <button class="edit-user-btn-cancel" (click)="closeEditCard()">Cancelar</button>
    </div>

    <div class="edit-user-confirm-modal" *ngIf="showConfirm">
      <p>Tem certeza que deseja alterar esse usuário?</p>
      <p><strong>Alterações feitas:</strong></p>
      <ul>
        <li *ngIf="selectedUser.username !== originalUser?.username">
          <strong>Nome:</strong> {{ originalUser?.username }} → {{ selectedUser.username }}
        </li>
        <li *ngIf="selectedUser.email !== originalUser?.email">
          <strong>Email:</strong> {{ originalUser?.email }} → {{ selectedUser.email }}
        </li>
        <li *ngIf="selectedUser.roleName !== originalUser?.roleName">
          <strong>Função:</strong> {{ originalUser?.roleName }} → {{ selectedUser.roleName }}
        </li>
      </ul>
      <div class="edit-user-confirm-buttons">
        <button class="edit-user-btn-confirm" (click)="confirmSave()">Confirmar</button>
        <button class="edit-user-btn-cancel" (click)="cancelSave()">Cancelar</button>
      </div>
    </div>
  </div>
</div>
<div class="delete-user-modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="delete-user-modal-container" (click)="$event.stopPropagation()">
    <h3 class="delete-user-modal-title">Tem certeza que deseja excluir o usuário?</h3>
    <p class="delete-user-modal-text">
      Digite o nome completo do usuário <strong>"{{ userToDelete?.username }}"</strong> para confirmar a exclusão
      permanente.
    </p>
    <input type="text" [(ngModel)]="deleteConfirmationText" placeholder="Digite o nome completo aqui"
      class="delete-user-modal-input" />
    <div class="delete-user-modal-buttons">
      <button [disabled]="deleteConfirmationText !== userToDelete?.username" class="delete-user-btn-confirm"
        (click)="confirmDelete()">Confirmar</button>
      <button class="delete-user-btn-cancel" (click)="closeDeleteModal()">Cancelar</button>
    </div>
  </div>
</div>